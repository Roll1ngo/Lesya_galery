{% extends "base.html" %}

{% load static %}

{% block title %} –ì–∞–ª–µ—Ä–µ—è –Ü–¥–µ–π {% endblock title %}

{% block content %}

<div class="bg-gray-900 pt-20 min-h-screen">
    {% if messages %}
    <ul class="max-w-4xl mx-auto p-4 space-y-2">
        {% for message in messages %}
        <li class="p-4 rounded-lg text-sm {% if message.tags == 'success' %}bg-green-800 text-green-100{% endif %} {% if message.tags == 'error' %}bg-red-800 text-red-100{% endif %} {% if message.tags == 'warning' %}bg-yellow-800 text-yellow-100{% endif %} {% if message.tags == 'info' %}bg-blue-800 text-blue-100{% endif %}">
            {{ message }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    <main class="p-6">
        <div class="columns-1 sm:columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4">
            {% for img in images %}
            <div class="break-inside-avoid bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300 relative">
                <div class="relative">
                    <img src="{{ img.image.url }}" alt="{{ img.title }}" class="w-full h-auto object-cover cursor-pointer" onclick="openModal('{{ img.image.url }}', '{{ img.title }}')">
                </div>
                <div class="p-4 flex justify-between items-center">
                    <!-- –ó–ê–ú–Ü–ù–ê –ù–ê–ó–í–ò –ù–ê –Ü–ö–û–ù–ö–ò –ö–ê–¢–ï–ì–û–†–Ü–ô -->
                    <div class="flex items-center space-x-2 flex-wrap">
                        {% if img.tags.all %}
                            {% for tag in img.tags.all %}
                            <span class="material-symbols-outlined text-blue-400 text-lg" title="{{ tag.name }}">
                                {{ tag.material_icon }}
                            </span>
                            {% endfor %}
                        {% else %}
                            <span class="text-gray-500 text-sm">–ë–µ–∑ —Ç–µ–≥—ñ–≤</span>
                        {% endif %}
                    </div>

                    <div class="flex space-x-2 flex-shrink-0">
                        {% if user.is_superuser %}
                        <!-- üåü –ö–ù–û–ü–ö–ê "–¢–ï–ì–ò" -->
                        <div class="relative inline-block text-left" x-data="{ open: false }" @click.away="open = false">
                            <button @click="open = !open"
                                    title="–ö–µ—Ä—É–≤–∞–Ω–Ω—è —Ç–µ–≥–∞–º–∏"
                                    class="fa-solid fa-window-restore text-gray-300 hover:text-blue-400 transition duration-300">
                            </button>

                            <!-- –í–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ —Ç–µ–≥—ñ–≤ -->
                            <div x-show="open"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="transform opacity-0 scale-95"
                                 x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="transform opacity-100 scale-100"
                                 x-transition:leave-end="transform opacity-0 scale-95"
                                 class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-gray-700 ring-1 ring-black ring-opacity-5 divide-y divide-gray-600 z-50 origin-top-right max-h-60 overflow-y-auto">

                                <div class="py-1">
                                    {% for tag in all_tags %}
                                    {% with tag_id_str=tag.id|stringformat:"s" %}
                                    <label class="flex items-center px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 cursor-pointer transition duration-150 ease-in-out">
                                        <input type="checkbox"
                                               class="tag-checkbox form-checkbox h-4 w-4 text-blue-600 bg-gray-800 border-gray-600 rounded mr-3 focus:ring-blue-500"
                                               data-image-id="{{ img.id }}"
                                               data-tag-id="{{ tag.id }}"
                                               {% if tag in img.tags.all %}checked{% endif %}
                                               onchange="toggleImageTag(this)">
                                        <!-- –ù–∞–∑–≤–∞ —Ç–µ–≥—É –∑ —ñ–∫–æ–Ω–∫–æ—é -->
                                        <span class="material-symbols-outlined text-blue-400 mr-2 text-sm">
                                            {{ tag.material_icon }}
                                        </span>
                                        {{ tag.name }}
                                    </label>
                                    {% endwith %}
                                    {% empty %}
                                        <div class="px-4 py-2 text-sm text-gray-400">–¢–µ–≥–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <!-- üåü –ö–Ü–ù–ï–¶–¨ –ë–õ–û–ö–£ -->

                        <a href="{% url 'delete_image' img.id %}"
                           title="–í–∏–¥–∞–ª–∏—Ç–∏ {{ img.title }}"
                           class="p-1 bg-gray-700 text-gray-300 rounded-md shadow-md border border-gray-500 hover:bg-red-600 hover:text-white transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </a>
                        {% endif %}
                        <a href="{{ download_url }}?filename={{ img.title|slugify }}.jpg"
                           download="{{ img.title|slugify }}.jpg"
                           title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ {{ img.title }}"
                           class="p-1 bg-gray-700 text-gray-300 rounded-md shadow-md border border-gray-500 hover:bg-gray-600 hover:text-blue-400 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-lg">–ó–æ–±—Ä–∞–∂–µ–Ω—å —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.</p>
            {% endfor %}
        </div>
    </main>
</div>
{% if images %}

<style>
#imageModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
}

#modalOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.85);
  cursor: pointer;
}

#modalContent {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);

  width: 90vw;
  height: 90vh;

  /* –î–û–ó–í–û–õ–Ø–Ñ–ú–û –ü–†–û–ö–†–£–¢–ö–£ */
  overflow: auto;

  z-index: 10000;

  display: flex;
  justify-content: center;
  /* –í–º—ñ—Å—Ç –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑–≤–µ—Ä—Ö—É */
  align-items: flex-start;

  background-color: transparent;
}

/* –û–ù–û–í–õ–ï–ù–ò–ô –ë–õ–û–ö –î–õ–Ø #modalImage */
#modalImage {
  max-width: none;
  max-height: none;

  width: auto;
  height: auto;
  object-fit: contain;

  border-radius: 8px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);

  transform: scale(1);
  transition: transform 0.3s ease-in-out;

  /* !!! –ö–õ–Æ–ß–û–í–ê –ó–ú–Ü–ù–ê: –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –≤—ñ–¥ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ –ª—ñ–≤–æ–≥–æ –∫—É—Ç–∞ !!! */
  transform-origin: 0 0;
}
/* –ö–Ü–ù–ï–¶–¨ –û–ù–û–í–õ–ï–ù–û–ì–û –ë–õ–û–ö–£ */

/* –û–ù–û–í–õ–ï–ù–Ü –°–¢–ò–õ–Ü –î–õ–Ø –ö–ù–û–ü–ö–ò –ó–ê–ö–†–ò–¢–¢–Ø */
#closeButton {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  background-color: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 32px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  transition: background-color 0.2s;
  z-index: 10002;
  line-height: 1;
}

#closeButton:hover {
  background-color: #dc2626;
}

/* –û–ù–û–í–õ–ï–ù–Ü –°–¢–ò–õ–Ü –î–õ–Ø –ö–ù–û–ü–û–ö –ó–£–ú–£ */
#zoomControls {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10002;
  display: flex;
  gap: 10px;
}

#zoomControls button {
  width: 50px;
  height: 50px;
  background-color: #3b82f6; /* Blue-500 */
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  transition: background-color 0.2s, transform 0.2s;
  line-height: 1;
}

#zoomControls button:hover {
  background-color: #2563eb; /* Blue-600 */
  transform: scale(1.05);
}


/* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏ */
#imageModal.show {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
</style>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É
let currentZoom = 1.0;
const MAX_ZOOM = 3.0;
const MIN_ZOOM = 1.0;

function changeZoom(delta) {
  const modalImage = document.getElementById('modalImage');
  const modalContent = document.getElementById('modalContent');
  if (!modalImage || !modalContent) return;

  let newZoom = currentZoom + delta;

  if (newZoom < MIN_ZOOM) {
    newZoom = MIN_ZOOM;
  } else if (newZoom > MAX_ZOOM) {
    newZoom = MAX_ZOOM;
  }

  // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –Ω–æ–≤–∏–π –º–∞—Å—à—Ç–∞–±
  modalImage.style.transform = `scale(${newZoom})`;
  currentZoom = newZoom;

  // --- –õ–û–ì–Ü–ö–ê –ü–†–û–ö–†–£–¢–ö–ò ---
  if (currentZoom > 1.0) {
    // 1. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—è (–ø–æ —Ü–µ–Ω—Ç—Ä—É)
    // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –∑–º—ñ—â–µ–Ω–Ω—è, —â–æ–± –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±—É–ª–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É
    const scaledWidth = modalImage.offsetWidth * newZoom;
    const scrollHorizontal = (scaledWidth - modalContent.clientWidth) / 2;
    modalContent.scrollLeft = scrollHorizontal > 0 ? scrollHorizontal : 0;

    // 2. –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–µ –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—è
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É –ø—Ä–æ–∫—Ä—É—Ç–∫—É –≤ –Ω—É–ª—å (–≤–µ—Ä—Ö–Ω—ñ–π –∫—Ä–∞–π),
    // –æ—Å–∫—ñ–ª—å–∫–∏ transform-origin: 0 0 –≤–∂–µ –∑–∞—Ñ—ñ–∫—Å—É–≤–∞–≤ –≤–µ—Ä—Ö–Ω—ñ–π –∫—Ä–∞–π
    modalContent.scrollTop = 0;

  } else {
    // –Ø–∫—â–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –º–∞—Å—à—Ç–∞–±, —Å–∫–∏–¥–∞—î–º–æ –ø—Ä–æ–∫—Ä—É—Ç–∫—É
    modalContent.scrollLeft = 0;
    modalContent.scrollTop = 0;
  }
}

function openModal(imageUrl, imageTitle) {
  console.log("openModal –≤–∏–∫–ª–∏–∫–∞–Ω–æ –∑ URL: ", imageUrl);

  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const overlay = document.getElementById('modalOverlay');

  // –°–∫–∏–¥–∞—î–º–æ –º–∞—Å—à—Ç–∞–± —Ç–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ
  currentZoom = 1.0;
  modalImage.style.transform = `scale(${currentZoom})`;
  const modalContent = document.getElementById('modalContent');
  modalContent.scrollLeft = 0;
  modalContent.scrollTop = 0;

  // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
  modalImage.src = imageUrl;
  modalImage.alt = imageTitle;

  // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
  modal.style.display = 'block';
  modal.classList.add('show');


 // –ë–ª–æ–∫—É—î–º–æ –ø—Ä–æ–∫—Ä—É—Ç–∫—É body
  document.body.style.overflow = 'hidden';

  // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ overlay
  overlay.onclick = function() {
    closeModal();
  };

  console.log("–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ.");
}

function closeModal() {
  console.log("closeModal –≤–∏–∫–ª–∏–∫–∞–Ω–æ.");

  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  // –•–æ–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
  modal.style.display = 'none';
  modal.classList.remove('show');

  // –°–∫–∏–¥–∞—î–º–æ –º–∞—Å—à—Ç–∞–± —Ç–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
  modalImage.style.transform = 'scale(1)';
  currentZoom = 1.0;
  const modalContent = document.getElementById('modalContent');
  modalContent.scrollLeft = 0;
  modalContent.scrollTop = 0;


  // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–∫—Ä—É—Ç–∫—É body
  document.body.style.overflow = '';

  console.log("–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑–∞–∫—Ä–∏—Ç–µ.");
}

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ Escape
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('imageModal');
    if (modal.style.display === 'block') {
      closeModal();
    }
  }
});
</script>
{% endif %}
<script>
// üåü –§–£–ù–ö–¶–Ü–Ø –û–ë–†–û–ë–ö–ò –ü–ï–†–ï–ú–ò–ö–ê–ù–ù–Ø –¢–ï–ì–Ü–í
function toggleImageTag(checkbox) {
    const imageId = checkbox.dataset.imageId;
    const tagId = checkbox.dataset.tagId;
    const isChecked = checkbox.checked;

    // 1. –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
    const data = {
        image_id: imageId,
        tag_id: tagId,
        action: isChecked ? 'add' : 'remove',
        // Django –≤–∏–º–∞–≥–∞—î CSRF —Ç–æ–∫–µ–Ω –¥–ª—è POST/PUT/DELETE –∑–∞–ø–∏—Ç—ñ–≤
        csrfmiddlewaretoken: getCookie('csrftoken')
    };

    // 2. –í–∏–∑–Ω–∞—á–∞—î–º–æ URL –æ–±—Ä–æ–±–∫–∏.
    // –í–ò –ü–û–í–ò–ù–ù–Ü –°–¢–í–û–†–ò–¢–ò –¶–ï–ô URL –í–ê–®–û–ú–£ urls.py!
    const url = '/api/toggle-tag/';

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': data.csrfmiddlewaretoken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            // –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 403 Forbidden)
            throw new Error('Server error: ' + response.statusText);
        }
        return response.json();
    })
    .then(result => {
        console.log('Success:', result);

        // –û—Å–∫—ñ–ª—å–∫–∏ –º–∏ –Ω–µ –æ–Ω–æ–≤–ª—é—î–º–æ DOM –¥–∏–Ω–∞–º—ñ—á–Ω–æ,
        // –Ω–∞–π–∫—Ä–∞—â–µ —Ä—ñ—à–µ–Ω–Ω—è ‚Äî —Ü–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É, —â–æ–± –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –Ω–æ–≤—ñ —Ç–µ–≥–∏
        // window.location.reload();
    })
    .catch(error => {
        console.error('Error toggling tag:', error);
        // –í—ñ–¥–∫–∞—Ç —Å—Ç–∞–Ω—É —á–µ–∫–±–æ–∫—Å—É —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏
        checkbox.checked = !isChecked;

        // –í–∏–≤–µ–¥–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–≥—É: ' + error.message);
    });
}

// –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω–∞ –∑ –∫—É–∫—ñ
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>


{% endblock content %}