{% extends "base.html" %}

{% load static %}

{% block title %} Галерея Ідей {% endblock title %}

{% block content %}

<div class="bg-gray-900 pt-20 min-h-screen">
    {% if messages %}
    <ul class="max-w-4xl mx-auto p-4 space-y-2">
        {% for message in messages %}
        <li class="p-4 rounded-lg text-sm {% if message.tags == 'success' %}bg-green-800 text-green-100{% endif %} {% if message.tags == 'error' %}bg-red-800 text-red-100{% endif %} {% if message.tags == 'warning' %}bg-yellow-800 text-yellow-100{% endif %} {% if message.tags == 'info' %}bg-blue-800 text-blue-100{% endif %}">
            {{ message }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    <main class="p-6">
        <div class="columns-1 sm:columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4">
            {% for img in images %}
            <div class="break-inside-avoid bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300 relative">
                <div class="relative">
                    <img src="{{ img.image.url }}" alt="{{ img.title }}" class="w-full h-auto object-cover cursor-pointer" onclick="openModal('{{ img.image.url }}', '{{ img.title }}')">
                </div>
                <div class="p-4 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-300 mr-2">{{ img.title }}</h2>
                    <div class="flex space-x-2 flex-shrink-0">
                        {% if user.is_superuser %}
                        <a href="{% url 'delete_image' img.id %}"
                           title="Видалити {{ img.title }}"
                           class="p-1 bg-gray-700 text-gray-300 rounded-md shadow-md border border-gray-500 hover:bg-red-600 hover:text-white transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </a>
                        {% endif %}
                        <a href="{{ download_url }}?filename={{ img.title|slugify }}.jpg"
                           download="{{ img.title|slugify }}.jpg"
                           title="Завантажити {{ img.title }}"
                           class="p-1 bg-gray-700 text-gray-300 rounded-md shadow-md border border-gray-500 hover:bg-gray-600 hover:text-blue-400 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-lg">Зображень ще не завантажено.</p>
            {% endfor %}
        </div>
    </main>
</div>

{% if is_desktop %}
<div id="imageModal" style="display: none;">
  <div id="modalOverlay"></div>

  <button id="closeButton" onclick="closeModal()">&times;</button>

  <div id="zoomControls">
    <button id="zoomOutButton" onclick="changeZoom(-0.1)" title="Зменшити">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
    <button id="zoomInButton" onclick="changeZoom(0.1)" title="Збільшити">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
  </div>
  <div id="modalContent">
    <img id="modalImage" src="" alt="">
  </div>
</div>

<style>
#imageModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
}

#modalOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.85);
  cursor: pointer;
}

#modalContent {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);

  width: 90vw;
  height: 90vh;

  /* ДОЗВОЛЯЄМО ПРОКРУТКУ */
  overflow: auto;

  z-index: 10000;

  display: flex;
  justify-content: center;
  /* Вміст починається зверху */
  align-items: flex-start;

  background-color: transparent;
}

/* ОНОВЛЕНИЙ БЛОК ДЛЯ #modalImage */
#modalImage {
  max-width: none;
  max-height: none;

  width: auto;
  height: auto;
  object-fit: contain;

  border-radius: 8px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);

  transform: scale(1);
  transition: transform 0.3s ease-in-out;

  /* !!! КЛЮЧОВА ЗМІНА: Масштабування від верхнього лівого кута !!! */
  transform-origin: 0 0;
}
/* КІНЕЦЬ ОНОВЛЕНОГО БЛОКУ */

/* ОНОВЛЕНІ СТИЛІ ДЛЯ КНОПКИ ЗАКРИТТЯ */
#closeButton {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  background-color: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 32px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  transition: background-color 0.2s;
  z-index: 10002;
  line-height: 1;
}

#closeButton:hover {
  background-color: #dc2626;
}

/* ОНОВЛЕНІ СТИЛІ ДЛЯ КНОПОК ЗУМУ */
#zoomControls {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10002;
  display: flex;
  gap: 10px;
}

#zoomControls button {
  width: 50px;
  height: 50px;
  background-color: #3b82f6; /* Blue-500 */
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  transition: background-color 0.2s, transform 0.2s;
  line-height: 1;
}

#zoomControls button:hover {
  background-color: #2563eb; /* Blue-600 */
  transform: scale(1.05);
}


/* Анімація появи */
#imageModal.show {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
</style>

<script>
// Глобальна змінна для відстеження поточного масштабу
let currentZoom = 1.0;
const MAX_ZOOM = 3.0;
const MIN_ZOOM = 1.0;

function changeZoom(delta) {
  const modalImage = document.getElementById('modalImage');
  const modalContent = document.getElementById('modalContent');
  if (!modalImage || !modalContent) return;

  let newZoom = currentZoom + delta;

  if (newZoom < MIN_ZOOM) {
    newZoom = MIN_ZOOM;
  } else if (newZoom > MAX_ZOOM) {
    newZoom = MAX_ZOOM;
  }

  // Застосовуємо новий масштаб
  modalImage.style.transform = `scale(${newZoom})`;
  currentZoom = newZoom;

  // --- ЛОГІКА ПРОКРУТКИ ---
  if (currentZoom > 1.0) {
    // 1. Горизонтальне прокручування (по центру)
    // Розраховуємо горизонтальне зміщення, щоб зображення було по центру
    const scaledWidth = modalImage.offsetWidth * newZoom;
    const scrollHorizontal = (scaledWidth - modalContent.clientWidth) / 2;
    modalContent.scrollLeft = scrollHorizontal > 0 ? scrollHorizontal : 0;

    // 2. Вертикальне прокручування
    // Встановлюємо вертикальну прокрутку в нуль (верхній край),
    // оскільки transform-origin: 0 0 вже зафіксував верхній край
    modalContent.scrollTop = 0;

  } else {
    // Якщо мінімальний масштаб, скидаємо прокрутку
    modalContent.scrollLeft = 0;
    modalContent.scrollTop = 0;
  }
}

function openModal(imageUrl, imageTitle) {
  console.log("openModal викликано з URL: ", imageUrl);

  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const overlay = document.getElementById('modalOverlay');

  // Скидаємо масштаб та прокрутку при відкритті
  currentZoom = 1.0;
  modalImage.style.transform = `scale(${currentZoom})`;
  const modalContent = document.getElementById('modalContent');
  modalContent.scrollLeft = 0;
  modalContent.scrollTop = 0;

  // Встановлюємо зображення
  modalImage.src = imageUrl;
  modalImage.alt = imageTitle;

  // Показуємо модальне вікно
  modal.style.display = 'block';
  modal.classList.add('show');


 // Блокуємо прокрутку body
  document.body.style.overflow = 'hidden';

  // Закриття при кліку на overlay
  overlay.onclick = function() {
    closeModal();
  };

  console.log("Модальне вікно відкрито.");
}

function closeModal() {
  console.log("closeModal викликано.");

  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  // Ховаємо модальне вікно
  modal.style.display = 'none';
  modal.classList.remove('show');

  // Скидаємо масштаб та прокрутку при закритті
  modalImage.style.transform = 'scale(1)';
  currentZoom = 1.0;
  const modalContent = document.getElementById('modalContent');
  modalContent.scrollLeft = 0;
  modalContent.scrollTop = 0;


  // Відновлюємо прокрутку body
  document.body.style.overflow = '';

  console.log("Модальне вікно закрите.");
}

// Закриття модального вікна при натисканні Escape
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('imageModal');
    if (modal.style.display === 'block') {
      closeModal();
    }
  }
});
</script>
{% endif %}

<!--<script>-->
<!--function forceDownload(url, filename) {-->
<!--  // 1. Створюємо посилання <a>-->
<!--  const a = document.createElement('a');-->

<!--  // 2. Встановлюємо URL, додаючи параметр для примусового завантаження (якщо він потрібен на сервері)-->
<!--  // На деяких бекендах (наприклад, Django) це може бути необхідно.-->
<!--  const finalUrl = url.includes('?') ? `${url}&fl_attachment=1` : `${url}?fl_attachment=1`;-->

<!--  // Встановлюємо атрибути-->
<!--  a.href = finalUrl;-->
<!--  a.download = filename; // Встановлюємо ім'я файлу-->
<!--  a.style.display = 'none';-->

<!--  // 3. Додаємо до DOM, клікаємо і видаляємо-->
<!--  document.body.appendChild(a);-->

<!--  try {-->
<!--      // Спроба програмного кліку-->
<!--      a.click();-->
<!--      console.log('Download initiated via a.click()');-->
<!--  } catch (e) {-->
<!--      // Якщо a.click() не спрацював (наприклад, на деяких мобільних),-->
<!--      // ми можемо відкрити його в новому вікні/вкладці, що іноді спрацьовує як завантаження.-->
<!--      console.error('a.click() failed, attempting window.open:', e);-->
<!--      window.open(finalUrl, '_blank');-->
<!--  }-->

<!--  // Затримка перед видаленням, щоб клік мав шанс спрацювати-->
<!--  setTimeout(() => {-->
<!--      document.body.removeChild(a);-->
<!--  }, 100);-->

<!--  // ВАЖЛИВО: Оскільки ми не використовуємо fetch, ми не можемо зловити мережеву помилку-->
<!--  // тут. Якщо завантаження не розпочалося, це часто пов'язано з дозволами-->
<!--  // користувача або налаштуваннями браузера.-->
<!--}-->
<!--</script>-->

{% endblock content %}